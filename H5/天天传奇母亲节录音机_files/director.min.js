(function(e){function t(e,t,n,r){var i=0,s=0,o=0,n=(n||"(").toString(),r=(r||")").toString(),u;for(u=0;u<e.length;u++){var a=e[u];if(a.indexOf(n,i)>a.indexOf(r,i)||~a.indexOf(n,i)&&!~a.indexOf(r,i)||!~a.indexOf(n,i)&&~a.indexOf(r,i)){s=a.indexOf(n,i),o=a.indexOf(r,i);if(~s&&!~o||!~s&&~o){var f=e.slice(0,(u||1)+1).join(t);e=[f].concat(e.slice((u||1)+1))}i=(o>s?o:s)+1,u=0}else i=0}return e}function n(e,t){var n,i=0,s="";while(n=e.substr(i).match(/[^\w\d\- %@&]*\*[^\w\d\- %@&]*/))i=n.index+n[0].length,n[0]=n[0].replace(/^\*/,"([_.()!\\ %@&a-zA-Z0-9-]+)"),s+=e.substr(0,n.index)+n[0];e=s+=e.substr(i);var o=e.match(/:([^\/]+)/ig),u,a;if(o){a=o.length;for(var f=0;f<a;f++)u=o[f],u.slice(0,2)==="::"?e=u.slice(1):e=e.replace(u,r(u,t))}return e}function r(e,t,n){n=e;for(var r in t)if(t.hasOwnProperty(r)){n=t[r](e);if(n!==e)break}return n===e?"([._a-zA-Z0-9-%()]+)":n}function i(e,t,n){if(!e.length)return n();var r=0;(function i(){t(e[r],function(t){t||t===!1?(n(t),n=function(){}):(r+=1,r===e.length?n():i())})})()}function o(e){var t=[];for(var n=0,r=e.length;n<r;n++)t=t.concat(e[n]);return t}function u(e,t){for(var n=0;n<e.length;n+=1)if(t(e[n],n,e)===!1)return}function a(){return f.hash===""||f.hash==="#"}var f=document.location,l={mode:"modern",hash:f.hash,history:!1,check:function(){var e=f.hash;e!=this.hash&&(this.hash=e,this.onHashChanged())},fire:function(){this.mode==="modern"?this.history===!0?window.onpopstate():window.onhashchange():this.onHashChanged()},init:function(e,t){function n(e){for(var t=0,n=c.listeners.length;t<n;t++)c.listeners[t](e)}var r=this;this.history=t,c.listeners||(c.listeners=[]);if("onhashchange"in window&&(document.documentMode===undefined||document.documentMode>7))this.history===!0?setTimeout(function(){window.onpopstate=n},500):window.onhashchange=n,this.mode="modern";else{var i=document.createElement("iframe");i.id="state-frame",i.style.display="none",document.body.appendChild(i),this.writeFrame(""),"onpropertychange"in document&&"attachEvent"in document&&document.attachEvent("onpropertychange",function(){event.propertyName==="location"&&r.check()}),window.setInterval(function(){r.check()},50),this.onHashChanged=n,this.mode="legacy"}return c.listeners.push(e),this.mode},destroy:function(e){if(!!c&&!!c.listeners){var t=c.listeners;for(var n=t.length-1;n>=0;n--)t[n]===e&&t.splice(n,1)}},setHash:function(e){return this.mode==="legacy"&&this.writeFrame(e),this.history===!0?(window.history.pushState({},document.title,e),this.fire()):f.hash=e[0]==="/"?e:"/"+e,this},writeFrame:function(e){var t=document.getElementById("state-frame"),n=t.contentDocument||t.contentWindow.document;n.open(),n.write("<script>_hash = '"+e+"'; onload = parent.listener.syncHash;<script>"),n.close()},syncHash:function(){var e=this._hash;return e!=f.hash&&(f.hash=e),this},onHashChanged:function(){}},c=e.Router=function(e){if(!(this instanceof c))return new c(e);this.params={},this.routes={},this.methods=["on","once","after","before"],this.scope=[],this._methods={},this._insert=this.insert,this.insert=this.insertEx,this.historySupport=(window.history!=null?window.history.pushState:null)!=null,this.configure(),this.mount(e||{})};c.prototype.init=function(e){var t=this,n;return this.handler=function(e){var n=e&&e.newURL||window.location.hash,r=t.history===!0?t.getPath():n.replace(/.*#/,"");t.dispatch("on",r.charAt(0)==="/"?r:"/"+r)},l.init(this.handler,this.history),this.history===!1?a()&&e?f.hash=e:a()||t.dispatch("on","/"+f.hash.replace(/^(#\/|#|\/)/,"")):(this.convert_hash_in_init?(n=a()&&e?e:a()?null:f.hash.replace(/^#/,""),n&&window.history.replaceState({},document.title,n)):n=this.getPath(),(n||this.run_in_init===!0)&&this.handler()),this},c.prototype.explode=function(){var e=this.history===!0?this.getPath():f.hash;return e.charAt(1)==="/"&&(e=e.slice(1)),e.slice(1,e.length).split("/")},c.prototype.setRoute=function(e,t,n){var r=this.explode();return typeof e=="number"&&typeof t=="string"?r[e]=t:typeof n=="string"?r.splice(e,t,s):r=[e],l.setHash(r.join("/")),r},c.prototype.insertEx=function(e,t,n,r){return e==="once"&&(e="on",n=function(e){var t=!1;return function(){if(!t)return t=!0,e.apply(this,arguments)}}(n)),this._insert(e,t,n,r)},c.prototype.getRoute=function(e){var t=e;if(typeof e=="number")t=this.explode()[e];else if(typeof e=="string"){var n=this.explode();t=n.indexOf(e)}else t=this.explode();return t},c.prototype.destroy=function(){return l.destroy(this.handler),this},c.prototype.getPath=function(){var e=window.location.pathname;return e.substr(0,1)!=="/"&&(e="/"+e),e};var h=/\?.*/;c.prototype.configure=function(e){e=e||{};for(var t=0;t<this.methods.length;t++)this._methods[this.methods[t]]=!0;return this.recurse=e.recurse||this.recurse||!1,this.async=e.async||!1,this.delimiter=e.delimiter||"/",this.strict=typeof e.strict=="undefined"?!0:e.strict,this.notfound=e.notfound,this.resource=e.resource,this.history=e.html5history&&this.historySupport||!1,this.run_in_init=this.history===!0&&e.run_handler_in_init!==!1,this.convert_hash_in_init=this.history===!0&&e.convert_hash_in_init!==!1,this.every={after:e.after||null,before:e.before||null,on:e.on||null},this},c.prototype.param=function(e,t){e[0]!==":"&&(e=":"+e);var n=new RegExp(e,"g");return this.params[e]=function(e){return e.replace(n,t.source||t)},this},c.prototype.on=c.prototype.route=function(e,n,r){var i=this;!r&&typeof n=="function"&&(r=n,n=e,e="on");if(Array.isArray(n))return n.forEach(function(t){i.on(e,t,r)});n.source&&(n=n.source.replace(/\\\//ig,"/"));if(Array.isArray(e))return e.forEach(function(e){i.on(e.toLowerCase(),n,r)});n=n.split(new RegExp(this.delimiter)),n=t(n,this.delimiter),this.insert(e,this.scope.concat(n),r)},c.prototype.path=function(e,n){var r=this,i=this.scope.length;e.source&&(e=e.source.replace(/\\\//ig,"/")),e=e.split(new RegExp(this.delimiter)),e=t(e,this.delimiter),this.scope=this.scope.concat(e),n.call(this,this),this.scope.splice(i,e.length)},c.prototype.dispatch=function(e,t,n){function r(){i.last=s.after,i.invoke(i.runlist(s),i,n)}var i=this,s=this.traverse(e,t.replace(h,""),this.routes,""),o=this._invoked,u;return this._invoked=!0,!s||s.length===0?(this.last=[],typeof this.notfound=="function"&&this.invoke([this.notfound],{method:e,path:t},n),!1):(this.recurse==="forward"&&(s=s.reverse()),u=this.every&&this.every.after?[this.every.after].concat(this.last):[this.last],u&&u.length>0&&o?(this.async?this.invoke(u,this,r):(this.invoke(u,this),r()),!0):(r(),!0))},c.prototype.invoke=function(e,t,n){var r=this,s;this.async?(s=function(n,r){if(Array.isArray(n))return i(n,s,r);typeof n=="function"&&n.apply(t,(e.captures||[]).concat(r))},i(e,s,function(){n&&n.apply(t,arguments)})):(s=function(n){if(Array.isArray(n))return u(n,s);if(typeof n=="function")return n.apply(t,e.captures||[]);typeof n=="string"&&r.resource&&r.resource[n].apply(t,e.captures||[])},u(e,s))},c.prototype.traverse=function(e,t,n,r,i){function s(e){function t(e){for(var n=e.length-1;n>=0;n--)Array.isArray(e[n])?(t(e[n]),e[n].length===0&&e.splice(n,1)):i(e[n])||e.splice(n,1)}function n(e){var t=[];for(var r=0;r<e.length;r++)t[r]=Array.isArray(e[r])?n(e[r]):e[r];return t}if(!i)return e;var r=n(e);return r.matched=e.matched,r.captures=e.captures,r.after=e.after.filter(i),t(r),r}var o=[],u,a,f,l,c;if(t===this.delimiter&&n[e])return l=[[n.before,n[e]].filter(Boolean)],l.after=[n.after].filter(Boolean),l.matched=!0,l.captures=[],s(l);for(var h in n)if(n.hasOwnProperty(h)&&(!this._methods[h]||this._methods[h]&&typeof n[h]=="object"&&!Array.isArray(n[h]))){u=a=r+this.delimiter+h,this.strict||(a+="["+this.delimiter+"]?"),f=t.match(new RegExp("^"+a));if(!f)continue;if(f[0]&&f[0]==t&&n[h][e])return l=[[n[h].before,n[h][e]].filter(Boolean)],l.after=[n[h].after].filter(Boolean),l.matched=!0,l.captures=f.slice(1),this.recurse&&n===this.routes&&(l.push([n.before,n.on].filter(Boolean)),l.after=l.after.concat([n.after].filter(Boolean))),s(l);l=this.traverse(e,t,n[h],u);if(l.matched)return l.length>0&&(o=o.concat(l)),this.recurse&&(o.push([n[h].before,n[h].on].filter(Boolean)),l.after=l.after.concat([n[h].after].filter(Boolean)),n===this.routes&&(o.push([n.before,n.on].filter(Boolean)),l.after=l.after.concat([n.after].filter(Boolean)))),o.matched=!0,o.captures=l.captures,o.after=l.after,s(o)}return!1},c.prototype.insert=function(e,t,r,i){var s,o,u,a,f;t=t.filter(function(e){return e&&e.length>0}),i=i||this.routes,f=t.shift(),/\:|\*/.test(f)&&!/\\d|\\w/.test(f)&&(f=n(f,this.params));if(t.length>0)return i[f]=i[f]||{},this.insert(e,t,r,i[f]);if(!!f||!!t.length||i!==this.routes){o=typeof i[f],u=Array.isArray(i[f]);if(i[f]&&!u&&o=="object"){s=typeof i[f][e];switch(s){case"function":i[f][e]=[i[f][e],r];return;case"object":i[f][e].push(r);return;case"undefined":i[f][e]=r;return}}else if(o=="undefined"){a={},a[e]=r,i[f]=a;return}throw new Error("Invalid route context: "+o)}s=typeof i[e];switch(s){case"function":i[e]=[i[e],r];return;case"object":i[e].push(r);return;case"undefined":i[e]=r;return}},c.prototype.extend=function(e){function t(e){n._methods[e]=!0,n[e]=function(){var t=arguments.length===1?[e,""]:[e];n.on.apply(n,t.concat(Array.prototype.slice.call(arguments)))}}var n=this,r=e.length,i;for(i=0;i<r;i++)t(e[i])},c.prototype.runlist=function(e){var t=this.every&&this.every.before?[this.every.before].concat(o(e)):o(e);return this.every&&this.every.on&&t.push(this.every.on),t.captures=e.captures,t.source=e.source,t},c.prototype.mount=function(e,n){function r(n,r){var s=n,o=n.split(i.delimiter),u=typeof e[n],a=o[0]===""||!i._methods[o[0]],f=a?"on":s;a&&(s=s.slice((s.match(new RegExp("^"+i.delimiter))||[""])[0].length),o.shift()),a&&u==="object"&&!Array.isArray(e[n])?(r=r.concat(o),i.mount(e[n],r)):(a&&(r=r.concat(s.split(i.delimiter)),r=t(r,i.delimiter)),i.insert(f,r,e[n]))}if(!!e&&typeof e=="object"&&!Array.isArray(e)){var i=this;n=n||[],Array.isArray(n)||(n=n.split(i.delimiter));for(var s in e)e.hasOwnProperty(s)&&r(s,n.slice(0))}}})(typeof exports=="object"?exports:window);